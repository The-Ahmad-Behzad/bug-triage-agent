<!DOCTYPE html>
<html lang="en" class="light"> <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Documentation Agent (Supervisor-Ready)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Simple scrollbar for chat */
        #chat-window::-webkit-scrollbar { width: 6px; }
        #chat-window::-webkit-scrollbar-track { background: transparent; }
        #chat-window::-webkit-scrollbar-thumb { background: #9ca3af; border-radius: 6px; }
        #chat-window::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        .dark #chat-window::-webkit-scrollbar-thumb { background: #4b5563; }
        .dark #chat-window::-webkit-scrollbar-thumb:hover { background: #6b7280; }

        /* --- Custom Loader Animations --- */
        @keyframes scan {
            0% { top: 0; }
            100% { top: 90%; }
        }
        .scanner-line {
            animation: scan 2s ease-in-out infinite alternate;
        }

        @keyframes pulse-text {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }
        .pulse-text {
            animation: pulse-text 3s ease-in-out infinite;
        }
        /* --- End of Loader CSS --- */
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 font-sans transition-colors duration-300">

    <div class="w-full max-w-3xl mx-auto h-screen bg-white dark:bg-gray-800 shadow-2xl flex flex-col p-0">
        
        <div class="flex-shrink-0 border-b border-gray-200 dark:border-gray-700 p-4 flex items-center justify-between">
            <div>
                <h1 class="text-xl font-bold text-gray-800 dark:text-white">Documentation Generator Agent</h1>
                <p class="text-sm text-gray-500 dark:text-gray-400">SUPERVISOR-COMPLIANT UI</p>
            </div>
            
            <div class="flex items-center space-x-2">
                <button id="theme-toggle" class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
                    <svg id="theme-toggle-light-icon" class="w-5 h-5 hidden" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.707.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-1.636 4.95l-.707.707a1 1 0 01-1.414-1.414l.707.707a1 1 0 011.414 1.414zm-12.02-4.95a1 1 0 01-1.414 0l-.707-.707a1 1 0 011.414-1.414l.707.707a1 1 0 010 1.414zM4 11a1 1 0 100-2H3a1 1 0 100 2h1z" fill-rule="evenodd" clip-rule="evenodd"></path></svg>
                    <svg id="theme-toggle-dark-icon" class="w-5 h-5 hidden" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg>
                </button>
                
                <button id="reset-button" class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700" title="Reset Demo">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9H0v5m11.168-9.832A8.001 8.001 0 0123.418 9H24V4m-4.582 13H24v-5h-.582a8.001 8.001 0 01-15.356-2H0v5h4.582c.352.618.78 1.19 1.282 1.707L0 24h13.168l3-3L20 24h4l-3.832-5.832z"></path></svg>
                </button>
            </div>
        </div>

        <div id="chat-window" class="flex-grow my-0 space-y-6 overflow-y-auto p-6 bg-white dark:bg-gray-800">
            <!-- Chat messages will be injected here -->
        </div>

        <div id="input-area" class="flex-shrink-0 border-t border-gray-200 dark:border-gray-700 p-4 bg-gray-50 dark:bg-gray-900">
            <div id="input-container" class="flex space-x-2">
                <!-- Input elements will be injected here -->
            </div>
            <p class="text-xs text-center text-gray-400 dark:text-gray-500 mt-2">Agent backend must be running on <code class="bg-gray-200 dark:bg-gray-600 px-1 rounded">https://api-documentation-agent.onrender.com/execute</code></p>
        </div>
    </div>

    <script>
        // === DOM Elements ===
        const chatWindow = document.getElementById('chat-window');
        const inputContainer = document.getElementById('input-container');
        const resetButton = document.getElementById('reset-button');
        const themeToggle = document.getElementById('theme-toggle');
        const lightIcon = document.getElementById('theme-toggle-light-icon');
        const darkIcon = document.getElementById('theme-toggle-dark-icon');

        // === Agent State ===
        // Stores all our choices before sending to the agent
        let agentState = {
            language: null,
            inputMode: null,
            gitRepoUrl: null,
            zipFileBase64: null,
            codeFilesBase64: [], // This is now an array of {file_path, content_base64}
            existingDoc: null // This will be the *content* of the JSON file
        };
        let chatState = 'START'; // Controls the chat flow

        // === Dark Mode Logic ===
        function setMode(isDark) {
            if (isDark) {
                document.documentElement.classList.add('dark');
                lightIcon.classList.remove('hidden');
                darkIcon.classList.add('hidden');
            } else {
                document.documentElement.classList.remove('dark');
                lightIcon.classList.add('hidden');
                darkIcon.classList.remove('hidden');
            }
        }
        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            setMode(true);
        } else {
            setMode(false);
        }
        themeToggle.onclick = () => {
            const isDark = document.documentElement.classList.toggle('dark');
            localStorage.theme = isDark ? 'dark' : 'light';
            setMode(isDark);
        };

        // === Chatbot UI Logic ===
        function addBotMessage(html) {
            const msgWrapper = document.createElement('div');
            msgWrapper.className = 'flex justify-start';
            msgWrapper.innerHTML = `
                <div class="flex-shrink-0 w-8 h-8 rounded-full bg-gray-600 dark:bg-gray-500 text-white flex items-center justify-center text-sm font-bold">A</div>
                <div class="ml-3 bot-bubble p-3 rounded-lg max-w-[80%] bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-white">
                    ${html}
                </div>
            `;
            chatWindow.appendChild(msgWrapper);
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        function addUserMessage(text) {
            const msgWrapper = document.createElement('div');
            msgWrapper.className = 'flex justify-end';
            msgWrapper.innerHTML = `
                <div class="mr-3 user-bubble p-3 rounded-lg max-w-[80%] bg-blue-600 text-white">
                    ${text}
                </div>
                <div class="flex-shrink-0 w-8 h-8 rounded-full bg-blue-600 text-white flex items-center justify-center text-sm font-bold">U</div>
            `;
            chatWindow.appendChild(msgWrapper);
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        // === NEW: Base64 File Reader ===
        /**
         * Reads a file and returns its Base64 encoded content.
         * @param {File} file The file to read.
         * @returns {Promise<string>} A promise that resolves with the Base64 string (without the data: prefix).
         */
        function readFileAsBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    // result is "data:mime/type;base64,ENCODED_STRING"
                    // We only want the "ENCODED_STRING"
                    const base64String = reader.result.split(',')[1];
                    resolve(base64String);
                };
                reader.onerror = (error) => reject(error);
                reader.readAsDataURL(file);
            });
        }
        
        /**
         * Reads a file and returns its text content.
         * @param {File} file The file to read.
         * @returns {Promise<string>} A promise that resolves with the text content.
         */
        function readFileAsText(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    resolve(reader.result);
                };
                reader.onerror = (error) => reject(error);
                reader.readAsText(file);
            });
        }


        // === Chat Flow Logic ===
        function renderInput() {
            inputContainer.innerHTML = ''; // Clear previous inputs

            switch (chatState) {
                case 'ASK_LANG':
                case 'ASK_MODE':
                case 'ASK_GIT_URL':
                    // Standard text input
                    const textInput = document.createElement('input');
                    textInput.type = 'text';
                    textInput.id = 'text-input';
                    textInput.className = 'flex-grow border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500';
                    textInput.placeholder = 'Type your answer...';
                    textInput.onkeydown = (e) => { if (e.key === 'Enter') handleSubmit(); };
                    inputContainer.appendChild(textInput);
                    
                    const sendButton = document.createElement('button');
                    sendButton.id = 'send-button';
                    sendButton.className = 'px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex-shrink-0';
                    sendButton.innerHTML = `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>`;
                    sendButton.onclick = handleSubmit;
                    inputContainer.appendChild(sendButton);
                    break;
                
                case 'ASK_ZIP':
                case 'ASK_FILES':
                case 'ASK_DOC':
                    // File input
                    const fileInput = document.createElement('input');
                    fileInput.type = 'file';
                    fileInput.id = 'file-input';
                    fileInput.className = 'block w-full text-sm text-gray-500 dark:text-gray-300 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-50 dark:file:bg-blue-900 file:text-blue-700 dark:file:text-blue-300 hover:file:bg-blue-100 dark:hover:file:bg-blue-800';
                    
                    if (chatState === 'ASK_FILES') fileInput.multiple = true;
                    if (chatState === 'ASK_ZIP') fileInput.accept = '.zip';
                    if (chatState === 'ASK_DOC') fileInput.accept = '.json, application/json';
                    
                    inputContainer.appendChild(fileInput);

                    const uploadButton = document.createElement('button');
                    uploadButton.id = 'upload-button';
                    uploadButton.textContent = 'Upload';
                    uploadButton.className = 'px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex-shrink-0';
                    uploadButton.onclick = () => handleSubmit(fileInput.files);
                    inputContainer.appendChild(uploadButton);

                    // Add a skip button for the 'existing doc' step
                    if (chatState === 'ASK_DOC') {
                         const skipButton = document.createElement('button');
                        skipButton.textContent = 'Skip';
                        skipButton.className = 'px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors flex-shrink-0';
                        skipButton.onclick = () => handleSubmit(null, true); // 'skip' flag
                        inputContainer.appendChild(skipButton);
                    }
                    break;
                
                case 'ANALYZING':
                    // Loader
                    inputContainer.innerHTML = `
                        <div class="w-full flex flex-col items-center space-y-3 p-4">
                            <p class="font-medium text-blue-600 dark:text-blue-400">Agent is analyzing... please wait.</p>
                            <div class="w-full h-32 bg-gray-900 dark:bg-black p-4 rounded-lg overflow-hidden relative border border-gray-700">
                                <div class="scanner-line absolute left-0 w-full h-1 bg-blue-400 opacity-60 shadow-lg" style="box-shadow: 0 0 10px #2563eb, 0 0 5px #2563eb;"></div>
                                <pre><code class="text-gray-600 dark:text-gray-700 pulse-text text-xs select-none">
&lt;router.get('/api/...', (req, res) => {
  // ...fetching 
  res.json(...);
});
def get_all_items():
    return db.query(Item).all()
                                </code></pre>
                            </div>
                        </div>`;
                    break;
                
                case 'DONE':
                    // Reset button
                    const newRunButton = document.createElement('button');
                    newRunButton.textContent = 'Start New Documentation Task';
                    newRunButton.className = 'w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors';
                    newRunButton.onclick = reset;
                    inputContainer.appendChild(newRunButton);
                    break;
            }
        }

        async function handleSubmit(files = null, skip = false) {
            let userInput = '';
            
            try {
                switch (chatState) {
                    case 'ASK_LANG':
                        userInput = document.getElementById('text-input').value.trim().toLowerCase();
                        if (!userInput) return;
                        addUserMessage(userInput);
                        agentState.language = userInput;
                        chatState = 'ASK_MODE';
                        addBotMessage("Got it. What's your input type? (Type: <b class='text-blue-500'>git</b>, <b class='text-blue-500'>zip</b>, or <b class='text-blue-500'>files</b>)");
                        break;

                    case 'ASK_MODE':
                        userInput = document.getElementById('text-input').value.trim().toLowerCase();
                        if (!['git', 'zip', 'files'].includes(userInput)) {
                            addBotMessage("Sorry, please type 'git', 'zip', or 'files'.");
                            return;
                        }
                        addUserMessage(userInput);
                        agentState.inputMode = userInput;
                        if (userInput === 'git') {
                            chatState = 'ASK_GIT_URL';
                            addBotMessage("Please paste the full <b class='text-blue-500'>HTTPS .git URL</b> of the repository.");
                        } else if (userInput === 'zip') {
                            chatState = 'ASK_ZIP';
                            addBotMessage("Please upload your project's <b class='text-blue-500'>.zip file</b>.");
                        } else if (userInput === 'files') {
                            chatState = 'ASK_FILES';
                            addBotMessage("Please upload one or more <b class='text-blue-500'>code files</b>.");
                        }
                        break;
                    
                    case 'ASK_GIT_URL':
                        userInput = document.getElementById('text-input').value.trim();
                        if (!userInput.endsWith('.git')) {
                            addBotMessage("That doesn't look like a valid .git URL. Please try again.");
                            return;
                        }
                        addUserMessage(userInput);
                        agentState.gitRepoUrl = userInput;
                        chatState = 'ASK_DOC';
                        addBotMessage("Great. Do you have an <b class='text-blue-500'>existing OpenAPI JSON file</b> to update? (Optional)");
                        break;
                    
                    case 'ASK_ZIP':
                        if (!files || files.length === 0) return;
                        addUserMessage(`Uploaded: ${files[0].name}`);
                        // NEW: Read as Base64
                        agentState.zipFileBase64 = await readFileAsBase64(files[0]);
                        chatState = 'ASK_DOC';
                        addBotMessage("Great. Do you have an <b class='text-blue-500'>existing OpenAPI JSON file</b> to update? (Optional)");
                        break;

                    case 'ASK_FILES':
                        if (!files || files.length === 0) return;
                        addUserMessage(`Uploaded: ${files.length} file(s)`);
                        // NEW: Read all files as Base64
                        agentState.codeFilesBase64 = [];
                        for (const file of files) {
                            const contentBase64 = await readFileAsBase64(file);
                            agentState.codeFilesBase64.push({
                                file_path: file.name, // Use file.name as the path
                                content_base64: contentBase64
                            });
                        }
                        chatState = 'ASK_DOC';
                        addBotMessage("Great. Do you have an <b class='text-blue-500'>existing OpenAPI JSON file</b> to update? (Optional)");
                        break;

                    case 'ASK_DOC':
                        if (skip) {
                            addUserMessage("No existing documentation.");
                            agentState.existingDoc = null;
                        } else {
                            if (!files || files.length === 0) return;
                            addUserMessage(`Uploaded: ${files[0].name}`);
                            // NEW: Read doc as text and parse it
                            const docText = await readFileAsText(files[0]);
                            agentState.existingDoc = JSON.parse(docText);
                        }
                        // We are ready to call the agent
                        chatState = 'ANALYZING';
                        renderInput(); // Show loader
                        await callAgent(); // Call the agent
                        break;
                }
            } catch (error) {
                // Handle errors during file processing (e.g., invalid JSON)
                console.error("HandleSubmit Error:", error);
                addBotMessage(`<b class="text-red-500">Error:</b> ${error.message}. Please check your file and try again.`);
                // Reset to the problematic step
                if (chatState === 'ANALYZING') {
                     chatState = 'ASK_DOC';
                }
            } finally {
                // Render the next input state (unless we are analyzing)
                if (chatState !== 'ANALYZING') {
                    renderInput();
                }
            }
        }

        /**
         * ⭐️ UPGRADED: This function now sends the Supervisor JSON payload
         */
        async function callAgent() {
            // 1. Build the "results/task" payload
            const taskPayload = {
                language: agentState.language,
                git_repo_url: agentState.inputMode === 'git' ? agentState.gitRepoUrl : null,
                zip_file_base64: agentState.inputMode === 'zip' ? agentState.zipFileBase64 : null,
                code_files_base64: agentState.inputMode === 'files' ? agentState.codeFilesBase64 : [],
                existing_documentation: agentState.existingDoc,
                search_patterns: null // We let the agent use its defaults
            };

            // 2. Build the full Supervisor Handshake
            const supervisorMessage = {
                message_id: `ui-msg-${Date.now()}`,
                sender: "supervisor_ui",
                recipient: "documentation_generator_agent",
                type: "task_assignment",
                timestamp: new Date().toISOString(),
                "results/task": taskPayload
            };

            const agentUrl = 'https://api-documentation-agent.onrender.com/execute';
            try {
                const response = await fetch(agentUrl, {
                    method: 'POST',
                    // 3. Send as JSON, not FormData
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(supervisorMessage), 
                });

                const result = await response.json();
                
                if (!response.ok || result.status === 'failed') {
                    const errorDetails = result["results/task"]?.error_details || result.message || 'The agent returned an unknown error.';
                    throw new Error(errorDetails);
                }

                // 4. Parse the NEW response structure
                const taskResult = result["results/task"];
                const message = taskResult.status_message || "Task completed.";
                const fileByFileResults = taskResult.file_by_file_results || [];
                const mergedDocumentation = taskResult.merged_documentation;

                addBotMessage(`<b>Success!</b> ${message}`);

                if (fileByFileResults.length > 0) {
                    addBotMessage("Here is the documentation breakdown by file:");
                    for (const fileResult of fileByFileResults) {
                        const { file_path, endpoints_found, documentation } = fileResult;
                        
                        if (endpoints_found === 0) {
                             addBotMessage(`
                                <div class="bg-gray-700 p-3 rounded-lg text-sm">
                                    <h4 class="font-bold text-gray-400">${file_path}</h4>
                                    <p class="italic text-gray-400">No API endpoints found in this file.</p>
                                </div>
                             `);
                             continue;
                        }

                        // Create a new message wrapper for this file
                        const fileMsgWrapper = document.createElement('div');
                        fileMsgWrapper.className = 'bg-gray-900 dark:bg-black p-4 rounded-lg text-sm overflow-x-auto border border-gray-700 mb-2';
                        
                        // Add file path header
                        const fileHeader = document.createElement('h4');
                        fileHeader.className = 'text-lg font-bold text-blue-400 mb-2 border-b border-gray-700 pb-1';
                        fileHeader.textContent = `${file_path} (${endpoints_found} endpoints found)`;
                        fileMsgWrapper.appendChild(fileHeader);

                        // Add JSON content
                        const pre = document.createElement('pre');
                        const code = document.createElement('code');
                        code.className = 'text-white';
                        code.textContent = JSON.stringify(documentation, null, 2);
                        pre.appendChild(code);
                        fileMsgWrapper.appendChild(pre);
                        
                        chatWindow.appendChild(fileMsgWrapper);
                    }
                }
                
                // Always show the full merged doc as a collapsible
                if (mergedDocumentation) {
                    const details = document.createElement('details');
                    details.className = 'mt-4';
                    details.innerHTML = `
                        <summary class="cursor-pointer text-gray-500 dark:text-gray-400 hover:text-white">
                            Show full merged OpenAPI documentation
                        </summary>
                        <div class="bg-gray-900 dark:bg-black p-4 mt-2 rounded-lg text-sm overflow-x-auto border border-gray-700">
                            <pre><code class="text-white">${JSON.stringify(mergedDocumentation, null, 2)}</code></pre>
                        </div>
                    `;
                    chatWindow.appendChild(details);
                }

                chatWindow.scrollTop = chatWindow.scrollHeight;

            } catch (error) {
                console.error('Fetch error:', error);
                let errMsg = error.message;
                if (error.message.includes('Failed to fetch')) {
                    errMsg = "<b>Connection Error!</b><br>Could not connect to the agent. Is your `app.js` server running on `localhost:3000`?";
                }
                addBotMessage(`<b class="text-red-500">Error:</b> ${errMsg}`);
            } finally {
                chatState = 'DONE';
                renderInput();
            }
        }

        function reset() {
            chatWindow.innerHTML = '';
            // Reset state
            agentState = {
                language: null, inputMode: null, gitRepoUrl: null,
                zipFileBase64: null, codeFilesBase64: [], existingDoc: null
            };
            chatState = 'ASK_LANG';
            addBotMessage("Hi! I'm the upgraded UI for the **Supervisor-Compliant** Agent. What <b class='text-blue-500'>language</b> is the code? (e.g., javascript, python, java)");
            renderInput();
        }

        // --- Start the chat ---
        resetButton.onclick = reset;
        reset(); 
    </script>
</body>
</html>